<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Editing the Sample Contract · CosmWasm Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Editing Code"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Editing the Sample Contract · CosmWasm Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="http://www.cosmwasm.com/"/><meta property="og:description" content="## Editing Code"/><meta property="og:image" content="http://www.cosmwasm.com/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="http://www.cosmwasm.com/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"/><link rel="alternate" type="application/atom+xml" href="http://www.cosmwasm.com/blog/atom.xml" title="CosmWasm Documentation Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="http://www.cosmwasm.com/blog/feed.xml" title="CosmWasm Documentation Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/cosm-wasm.png" alt="CosmWasm Documentation"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/intro/overview" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="https://github.com/confio/cosmwasm" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Getting Started</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Intro<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/intro/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/multichain">Multi-Chain</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/actor">Actor Model</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/addresses">Names and Addresses</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/query">Querying</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/serialization">Serialization</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/roadmap">Roadmap</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/getting-started/intro">First Contract</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started/smart-contracts">Smart Contracts</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started/using-the-sdk">Cosmos SDK</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started/rust-basics">Rust Basics</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/getting-started/editing-escrow-contract">Editing Contracts</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started/first-demo">Deploying to Testnet</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Name Service<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/name-service/intro">Intro</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Production Tooling<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/tooling/verify">Verifying Code</a></li><li class="navListItem"><a class="navItem" href="/docs/tooling/reviews">Reviewing Code</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Editing the Sample Contract</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="editing-code"></a><a href="#editing-code" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Editing Code</h2>
<p>Now that you can compile and run tests, let's try to make some changes to the code and you can see if they work. If you didn't do this already in the last section, it is time to clone the examples repo and check out the escrow code:</p>
<pre><code class="hljs css language-bash">git <span class="hljs-built_in">clone</span> https://github.com/CosmWasm/cosmwasm-examples
<span class="hljs-built_in">cd</span> cosmwasm-examples/escrow
git checkout escrow-0.3.0
</code></pre>
<p>Note: This guide is compatible with <code>CosmWasm</code> and <code>wasmd</code> <code>v0.7.x</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="a-walk-through-of-the-escrow-contract"></a><a href="#a-walk-through-of-the-escrow-contract" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A Walk-Through of the Escrow Contract</h2>
<h3><a class="anchor" aria-hidden="true" id="data-structures"></a><a href="#data-structures" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Data Structures</h3>
<p>There are three key data structures used in the contract - for encoding the instantiation message, for encoding the execution messages, and for storing the contract data. We define all messages in <code>src/msg.rs</code>. The <code>State</code> structs are often in <code>state.rs</code>, but if only one then just inline in <code>contracts.rs</code>.</p>
<p>All of them must be prefixed with a long <code>derive</code> line to add various functionality. Otherwise, it should be pretty clear how the <code>State</code> defines the current condition of a contract, and <code>InitMsg</code> will provide the initial data to configure said contract. Please note that <code>State</code> is the <em>only information</em> persisted between multiple contract calls. Purpose of these <code>derive</code> directives:</p>
<ul>
<li><code>Serialize</code>, <code>Deserialize</code> generate methods so the <a href="https://github.com/serde-rs/json"><code>serde-json</code></a> library can de-serialize them (there is no <a href="https://en.wikipedia.org/wiki/Reflection_(computer_programming)">reflection</a> in rust)</li>
<li><code>Clone</code> allows you to make a copy of the object (<code>msg.clone()</code>)</li>
<li><code>Debug</code> and <code>PartialEq</code> are very useful for testing. In particular they allow the use of <code>assert_eq!(expected, msg);</code></li>
<li><code>JsonSchema</code> is needed by <a href="https://docs.rs/schemars/0.5.0/schemars"><code>schemars</code></a>, so we can use <a href="https://docs.rs/schemars/0.5.0/schemars/macro.schema_for.html"><code>schema_for!</code></a> to generate the json schema objects (in <code>schema/*.json</code>)</li>
</ul>
<p>From <code>contract.rs</code>:</p>
<pre><code class="hljs css language-rust"><span class="hljs-meta">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">State</span></span> {
    <span class="hljs-keyword">pub</span> arbiter: CanonicalAddr,
    <span class="hljs-keyword">pub</span> recipient: CanonicalAddr,
    <span class="hljs-keyword">pub</span> source: CanonicalAddr,
    <span class="hljs-keyword">pub</span> end_height: <span class="hljs-built_in">i64</span>,
    <span class="hljs-keyword">pub</span> end_time: <span class="hljs-built_in">i64</span>,
}
</code></pre>
<p>From <code>msg.rs</code>:</p>
<pre><code class="hljs css language-rust"><span class="hljs-meta">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">InitMsg</span></span> {
    <span class="hljs-keyword">pub</span> arbiter: HumanAddr,
    <span class="hljs-keyword">pub</span> recipient: HumanAddr,
    <span class="hljs-comment">// you can set a last time or block height the contract is valid at</span>
    <span class="hljs-comment">// if *either* is non-zero and below current state, the contract is considered expired</span>
    <span class="hljs-comment">// and will be returned to the original funder</span>
    <span class="hljs-keyword">pub</span> end_height: <span class="hljs-built_in">i64</span>,
    <span class="hljs-keyword">pub</span> end_time: <span class="hljs-built_in">i64</span>,
}
</code></pre>
<p>Note that we use <code>CanonicalAddr</code>, which is the binary representation and unchanging over the lifetime of the chain, for storage inside <code>State</code>, while we use <code>HumanAddr</code>, which is the typical cli format (eg bech32 encoding), for messages and anything that interacts with the user. There is <a href="../intro/addresses">more info on addresses here</a>.</p>
<p>Moving to the <code>HandleMsg</code> type, which defines the different contract methods, we make use of a slightly more complex rust construction, the <a href="https://doc.rust-lang.org/stable/rust-by-example/custom_types/enum.html"><code>enum</code></a>. This is also known as <a href="https://en.wikipedia.org/wiki/Tagged_union">a tagged union or sum type</a>, and contains a fixed set of defined possible data types, or <code>variants</code>, <em>exactly one of which must be set</em>. We use each <code>variant</code> to encode a different method. For example <code>HandleMsg::Refund{}</code> is a serializable request to refund the escrow, which is only valid after a timeout.</p>
<pre><code class="hljs css language-rust"><span class="hljs-meta">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="hljs-meta">#[serde(rename_all = <span class="hljs-meta-string">"lowercase"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">HandleMsg</span></span> {
    Approve {
        <span class="hljs-comment">// release some coins - if quantity is None, release all coins in balance</span>
        quantity: <span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">Vec</span>&lt;Coin&gt;&gt;,
    },
    Refund {},
}
</code></pre>
<p>You can see another directive here (<code>#[serde(rename_all = &quot;lowercase&quot;)]</code>). This ensure the json looks like: <code>{&quot;approve&quot;: {&quot;quantity&quot;: ...}}</code> instead of <code>{&quot;Approve&quot;: {&quot;quantity&quot;: ...}}</code>. This controls the code generated with <code>Serialize</code> and <code>Deserialize</code>. You see how compile-time codegen (via derive and macros) is a corner-stone of rust, and provides much of the functionality provided by runtime reflection in other, more dynamic, languages.</p>
<h3><a class="anchor" aria-hidden="true" id="json-format"></a><a href="#json-format" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSON Format</h3>
<p>When a <code>HandleMsg</code> instance is encoded, it will end up looking like <code>{&quot;approve&quot;: {&quot;quantity&quot;: [{&quot;amount&quot;: &quot;10&quot;, &quot;denom&quot;: &quot;ATOM&quot;}]}}</code> or <code>{&quot;refund&quot;: {}}</code>. This is also the format we should use client side, when submitting a message body to later be processed by <code>handle</code>. We are planning on modifying this for a stable v1 to look more like a json-rpc call format (which requires minimal code change in rust, mainly in the external format). It would then look more like: <code>{&quot;method&quot;: &quot;approve&quot;, &quot;params&quot;: {&quot;quantity&quot;: [{&quot;amount&quot;: &quot;10&quot;, &quot;denom&quot;: &quot;ATOM&quot;}]}}</code>. This would only affect the client-side code, and will be well documented when we start building out any client-side tooling.</p>
<h3><a class="anchor" aria-hidden="true" id="instantiation-logic"></a><a href="#instantiation-logic" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Instantiation Logic</h3>
<p>The <code>init</code> function will be called exactly once, before the contract is executed. It is a &quot;privileged&quot; function in that it can set configuration that can never be modified by any other method call. If you look at this example, the first line parses the input from raw bytes into our contract-defined message. We then create the initial state, and check if it is expired already. If expired, we return a generic contract error, otherwise, we store the state and return a success code:</p>
<pre><code class="hljs css language-rust"><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">init</span></span>&lt;S: Storage, A: Api&gt;(
    deps: &amp;<span class="hljs-keyword">mut</span> Extern&lt;S, A&gt;,
    env: Env,
    msg: InitMsg,
) -&gt; <span class="hljs-built_in">Result</span>&lt;Response&gt; {
    <span class="hljs-keyword">let</span> state = State {
        arbiter: deps.api.canonical_address(&amp;msg.arbiter)?,
        recipient: deps.api.canonical_address(&amp;msg.recipient)?,
        source: env.message.signer.clone(),
        end_height: msg.end_height,
        end_time: msg.end_time,
    };
    <span class="hljs-keyword">if</span> state.is_expired(&amp;env) {
        contract_err(<span class="hljs-string">"creating expired escrow"</span>)
    } <span class="hljs-keyword">else</span> {
        config(&amp;<span class="hljs-keyword">mut</span> deps.storage).save(&amp;state)?;
        <span class="hljs-literal">Ok</span>(Response::default())
    }
}
</code></pre>
<p><code>config</code> is defined above and is a helper wrapper for interacting with the underlying <code>Storage</code>. It handles prefixing and de/serializing
for you automatically, removing some boilerplate. It is completely optional and you can use <code>Storage</code> directly as well. We also encourage
you to develop other shared libraries for interacting with <code>Storage</code> if you want to make certain use cases easier (eg. representing a queue):</p>
<pre><code class="hljs css language-rust"><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">config</span></span>&lt;S: Storage&gt;(storage: &amp;<span class="hljs-keyword">mut</span> S) -&gt; Singleton&lt;S, State&gt; {
    singleton(storage, <span class="hljs-string">b"config"</span>)
}
</code></pre>
<p>You may wonder about the <code>clone()</code> in <code>source: env.message.signer.clone()</code>. This has to do with rust lifetimes. If I pass in a variable, I give &quot;ownership&quot; to the other structure and may no longer use it in my code. Since I need to access a reference to env later to check expiration, <code>state.is_expired(&amp;env)</code>, I must first clone the struct. If I did not reference <code>env</code> anywhere below, I would not need the <code>clone</code>.</p>
<p>Try to remove the <code>.clone()</code> and compile. See what your IDE or compile says.</p>
<h3><a class="anchor" aria-hidden="true" id="execution-logic"></a><a href="#execution-logic" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Execution Logic</h3>
<p>Just as <code>init</code> is the entry point for instantiating a new contract, <code>handle</code> is the entry point for executing the code. Since <code>handle</code> takes an <code>enum</code> with multiple <code>variants</code>, we can't just jump into the business logic, but first start with loading the state, and dispatching the message:</p>
<pre><code class="hljs css language-rust"><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">handle</span></span>&lt;S: Storage, A: Api&gt;(
    deps: &amp;<span class="hljs-keyword">mut</span> Extern&lt;S, A&gt;,
    env: Env,
    msg: HandleMsg,
) -&gt; <span class="hljs-built_in">Result</span>&lt;Response&gt; {
    <span class="hljs-keyword">let</span> state = config(&amp;<span class="hljs-keyword">mut</span> deps.storage).load()?;
    <span class="hljs-keyword">match</span> msg {
        HandleMsg::Approve { quantity } =&gt; try_approve(&amp;deps.api, env, state, quantity),
        HandleMsg::Refund {} =&gt; try_refund(&amp;deps.api, env, state),
    }
}
</code></pre>
<p>Since CosmWasm 0.6.0, we will parse the incoming json into a contract-specific <code>HandleMsg</code> automatically before calling, assuming a JSON-encoding message. We also see the use of <code>config</code> again to load without any boilerplate. Note the trailing <code>?</code>. This works on <code>Result</code> types and means, &quot;If this is an error, return the underlying error. If this is a success, give me the value&quot;. It is a very useful shorthand all over rust and replaces the <code>if err != nil { return err }</code> boilerplate in Go.</p>
<p>You will also see the <a href="https://doc.rust-lang.org/1.30.0/book/2018-edition/ch06-02-match.html"><code>match</code> statement</a>. This is another nice Rust idiom, and allows you to <code>switch</code> over multiple patterns. Here we check the multiple variants of the <code>HandleMsg</code> enum. Note that if you don't cover all cases, the compiler will refuse to proceed.</p>
<p>We pass in <code>&amp;deps.api</code> to give the handlers access to the &quot;precompiles&quot; from the runtime, which provide blockchain-specific logic. In particular, we currently use this to translate <code>CanonicalAddr</code> to <code>HumanAddr</code> in a blockchain-specific manner.</p>
<p>If we now look into the <code>try_approve</code> function, we will see how we can respond to a message. We can return an <code>unauthorized</code> error if the <code>signer</code> is not what we expect, and custom <code>contract_err</code> if our business logic rejects the message. The <code>let amount =</code> line shows how we can use pattern matching to use the number of coins present in the msg if provided, or default to the entire balance of the contract. Mastering <code>match</code> is very useful for Rust development.</p>
<pre><code class="hljs css language-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">try_approve</span></span>&lt;A: Api&gt;(
    api: &amp;A,
    params: Params,
    state: State,
    quantity: <span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">Vec</span>&lt;Coin&gt;&gt;,
) -&gt; <span class="hljs-built_in">Result</span>&lt;Response&gt; {
    <span class="hljs-keyword">if</span> params.message.signer != state.arbiter {
        unauthorized()
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> state.is_expired(&amp;params) {
        contract_err(<span class="hljs-string">"escrow expired"</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-meta">#[allow(clippy::or_fun_call)]</span>
        <span class="hljs-keyword">let</span> amount = quantity.unwrap_or(params.contract.balance.unwrap_or_default());
        send_tokens(
            api,
            &amp;params.contract.address,
            &amp;state.recipient,
            amount,
            <span class="hljs-string">"paid out funds"</span>,
        )
    }
}
</code></pre>
<p>At the end, on success, we want to send some tokens. Cosmwasm contracts cannot call other contracts directly, instead, we create a message to represent our request (<code>CosmosMsg::Send</code>) and return it as our contract ends. This will be parsed by the <code>wasm</code> module in go and it will execute and defined actions <em>in the same transaction</em>. This means, that while we will not get access to the return value, we can be ensured that if the send fails (user specified more coins than were in the escrow), all state changes in this contract would be reverted... just as if we returned a <code>ContractErr</code>. This is pulled into a helper to make the code clearer:</p>
<pre><code class="hljs css language-rust"><span class="hljs-comment">// this is a helper to move the tokens, so the business logic is easy to read</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">send_tokens</span></span>&lt;A: Api&gt;(
    api: &amp;A,
    from_address: &amp;CanonicalAddr,
    to_address: &amp;CanonicalAddr,
    amount: <span class="hljs-built_in">Vec</span>&lt;Coin&gt;,
    action: &amp;<span class="hljs-built_in">str</span>,
) -&gt; <span class="hljs-built_in">Result</span>&lt;Response&gt; {
    <span class="hljs-keyword">let</span> from_human = api.human_address(from_address)?;
    <span class="hljs-keyword">let</span> to_human = api.human_address(to_address)?;
    <span class="hljs-keyword">let</span> log = <span class="hljs-built_in">vec!</span>[log(<span class="hljs-string">"action"</span>, action), log(<span class="hljs-string">"to"</span>, to_human.as_str())];

    <span class="hljs-keyword">let</span> r = Response {
        messages: <span class="hljs-built_in">vec!</span>[CosmosMsg::<span class="hljs-built_in">Send</span> {
            from_address: from_human,
            to_address: to_human,
            amount,
        }],
        log: log,
        data: <span class="hljs-literal">None</span>,
    };
    <span class="hljs-literal">Ok</span>(r)
}
</code></pre>
<p>Note that <code>Env</code> encodes a lot of information from the blockchain, essentially providing the <code>Context</code> if you are coming from <code>cosmos-sdk</code>. This is validated data and can be trusted to compare any messages against. Refer to <a href="https://github.com/CosmWasm/cosmwasm/blob/v0.7.0/src/types.rs#L62-L89">the standard <code>cosmwasm</code> types</a> for references to all the available types in the environment.</p>
<h2><a class="anchor" aria-hidden="true" id="adding-a-new-message"></a><a href="#adding-a-new-message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding a New Message</h2>
<p>In this example, we will modify this contract to add some more functionality. In particular, let's make a backdoor to the contract. In the form of a <code>HandleMsg::Steal</code> variant that must be signed by some hard coded <code>THIEF</code> address and will release the entire contract balance to an address included in the message. Simple?</p>
<p>Note that this also demonstrates the need to verify the code behind a contract rather than just rely on raw wasm. Since we have a reproducible compilation step (details below), if I show you code I claim to belong to the contract, you can compile it and compare the hash to the hash stored on the blockchain, to verify that this really is the original rust code. We will be adding tooling to automate this step and make it simpler in the coming months, but for now, this example serves to demonstrate why it is important.</p>
<h3><a class="anchor" aria-hidden="true" id="adding-the-handler"></a><a href="#adding-the-handler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding the Handler</h3>
<p>Open up <code>src/msg.rs</code> in your <a href="./rust-basics#setting-up-your-ide">editor of choice</a> and let's add another variant to the <code>HandleMsg</code> enum, called <code>Steal</code>. Remember, it must have a destination address:</p>
<p><a href="./edit-escrow-hints#handlemsg">Need a hint?</a></p>
<p>Now, you can add the message handler. As a quick check, try running <code>cargo wasm</code> or look for the compile error in your IDE. Remember what I told you about <code>match</code>? Okay, now, add a function to process the <code>HandleMsg::Steal</code> variant. For the top level <code>THIEF</code>, you can use a placeholder address (we will set this to an address you own before deploying).</p>
<p><a href="./edit-escrow-hints#adding-handler">Need a hint?</a></p>
<p>Once you are done, check that it compiles:</p>
<pre><code class="hljs css language-bash">cargo wasm
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="writing-a-test"></a><a href="#writing-a-test" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing a Test</h3>
<p>We have a number of tests inside of <code>contracts.rs</code> that serve as templates, so let's make use of them. You can copy the <code>handle_refund</code> test and rename it to <code>handle_steal</code>. Remember to include the <code>#[test]</code> declaration on top. Now, go in and edit it to test that the THIEF can indeed steal the funds, and no one else can. Make sure our backdoor is working properly before we try to use it.</p>
<p>Now, try running <code>cargo unit-test</code> and see if your code works as planned. If it fails, try <code>RUST_BACKTRACE=1 cargo unit-test</code> to get a full stack trace. Now, isn't that nicer than trying to test Solidity contracts?</p>
<p><a href="./edit-escrow-hints#test-steal">See solution here</a></p>
<h3><a class="anchor" aria-hidden="true" id="checking-gas-usage"></a><a href="#checking-gas-usage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Checking Gas Usage</h3>
<p>You can port the existing test to an integration test to ensure the compiled code also works. The integration tests can also use feature flags to test gas metering with the &quot;singlepass&quot; backend, you need to instrument the code to only run with metering enabled, and run this with rust nightly.</p>
<p>Both of these cases will be explained in detail in a future tutorial. But I can promise you, any gas costs for computation will be negligible compared to the costs for reading/writing storage (including moving tokens).</p>
<h2><a class="anchor" aria-hidden="true" id="compiling-for-production"></a><a href="#compiling-for-production" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiling for Production</h2>
<p>After we have our tested contract, we can run <code>cargo wasm</code>. But check out the size of the output:</p>
<pre><code class="hljs css language-bash">$ cargo wasm
$ du -h target/wasm32-unknown-unknown/release/cw_escrow.wasm
1.8M    target/wasm32-unknown-unknown/release/cw_escrow.wasm
</code></pre>
<p>This works, but is huge for a blockchain transaction. Let's try to make it smaller. Turns out there is a linker flag to strip off debug information (Thanks Max):</p>
<pre><code class="hljs css language-bash">$ RUSTFLAGS=<span class="hljs-string">'-C link-arg=-s'</span> cargo wasm
$ du -h target/wasm32-unknown-unknown/release/cw_escrow.wasm
112K    target/wasm32-unknown-unknown/release/cw_escrow.wasm
</code></pre>
<p>This is looking much better.</p>
<h3><a class="anchor" aria-hidden="true" id="reproduceable-builds"></a><a href="#reproduceable-builds" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reproduceable builds</h3>
<p>The typical case for production is just using the <a href="https://github.com/CosmWasm/cosmwasm-opt"><code>cosmwasm-opt</code></a>. This requires <code>docker</code> to be installed on your system first. With that in, you can just follow the instructions on the <a href="https://github.com/CosmWasm/cosmwasm-opt/blob/v0.7.0/README.md">README</a>:</p>
<pre><code class="hljs css language-bash">docker run --rm -v $(<span class="hljs-built_in">pwd</span>):/code \
  --mount <span class="hljs-built_in">type</span>=volume,<span class="hljs-built_in">source</span>=$(basename $(<span class="hljs-built_in">pwd</span>))_cache,target=/code/target \
  --mount <span class="hljs-built_in">type</span>=volume,<span class="hljs-built_in">source</span>=registry_cache,target=/usr/<span class="hljs-built_in">local</span>/cargo/registry \
  confio/cosmwasm-opt:0.7.3
</code></pre>
<p>It will output a file called <code>contract.wasm</code> in the project directory (same directory as <code>Cargo.toml</code>, one above <code>contract.rs</code>), as well as <code>hash.txt</code> with the sha256 hash. It will also update the schemas in <code>schema/handle_msg.json</code>. To see the effect of optimization, look at the file size now:</p>
<pre><code class="hljs css language-text">$ du -h contract.wasm
96K     contract.wasm
</code></pre>
<p>This is very similar to the build process above, but does a second pass to strip out any dead weight, including debug info and labels.
But the main goal here is to make a reproduceable build, so that if someone tries to compile the code on a different machine 6 months later, they
get the same output, byte for byte. This allows us to start proving claims of the source code behind various wasm components on chain.</p>
<p>If you cut-paste code from the given solutions, you should have an identical sha256sum. (And if any line is different, this should be different, but consistent over multiple runs of the docker image above):</p>
<pre><code class="hljs css language-text">$ cat hash.txt
96babc67673eed23868622f0b89973ffc1196b758caa7b061da3f2f609d606b0  contract.wasm
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="schema"></a><a href="#schema" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Schema</h3>
<p>We can also generate JSON Schemas that serve as a guide for anyone trying to use the contract. To specify which arguments they need.
We do plan to eventually release some tooling that uses those to auto-build clients with proper type-checks, but so far it is just for
documentation purposes, if you don't want to dig into the Rust code to see the proper arguments. Go ahead and regenerate the schemas:</p>
<pre><code class="hljs css language-bash">cargo schema
</code></pre>
<p>Now you should see the definition for the <code>&quot;steal&quot;</code> call added:</p>
<pre><code class="hljs css language-bash">grep -A9 steal schema/handle_msg.json
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="debuggable-builds"></a><a href="#debuggable-builds" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Debuggable Builds</h3>
<p>If you want to try to inspect the output, and figure out where to optimize, you will want to only do the first step of the build process, without <code>wasm-opt</code>. This leaves in some symbol names and you can use <code>twilly</code> to get info on which functions are using up all the space. This is only needed if you find the contract is too big and you want to check which dependencies are responsible. Just add some extra flags to the normal cargo build, as we did above:</p>
<pre><code class="hljs css language-bash">RUSTFLAGS=<span class="hljs-string">'-C link-arg=-s'</span> cargo wasm
du -h target/wasm32-unknown-unknown/release/escrow.wasm
</code></pre>
<p>This is 112K, slightly larger than the fully compressed build above. However, it does contain more symbols, which allow one to use
<a href="https://rustwasm.github.io/twiggy/"><code>twiggy</code></a> and other tools to inspect which functions are taking up space.
The <code>cosmwasm</code> repo also has a <a href="https://github.com/CosmWasm/cosmwasm/blob/v0.7.0/Building.md">longer discussion of the build process</a>.</p>
<p>In the current build, most usage seems to be out actual business logic, as well as a contribution from <code>serde_json_wasm</code> (which is far,
far smaller than the original <code>serde_json</code> library). If you start pulling in more dependencies into your contracts and the size increases unexpectedly,
this is a good place to track down where the bloat comes from and possibly remove it. This is the technique I used to reduce the build size from 172kB
down to 68kB in an earlier version of CosmWasm (with less functionality).
These techniques may be useful for others, especially when pulling in many new libraries.</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 3/12/2020 by Ethan Frey</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/getting-started/rust-basics"><span class="arrow-prev">← </span><span>Rust Basics</span></a><a class="docs-next button" href="/docs/getting-started/first-demo"><span>Deploying to Testnet</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#editing-code">Editing Code</a></li><li><a href="#a-walk-through-of-the-escrow-contract">A Walk-Through of the Escrow Contract</a><ul class="toc-headings"><li><a href="#data-structures">Data Structures</a></li><li><a href="#json-format">JSON Format</a></li><li><a href="#instantiation-logic">Instantiation Logic</a></li><li><a href="#execution-logic">Execution Logic</a></li></ul></li><li><a href="#adding-a-new-message">Adding a New Message</a><ul class="toc-headings"><li><a href="#adding-the-handler">Adding the Handler</a></li><li><a href="#writing-a-test">Writing a Test</a></li><li><a href="#checking-gas-usage">Checking Gas Usage</a></li></ul></li><li><a href="#compiling-for-production">Compiling for Production</a><ul class="toc-headings"><li><a href="#reproduceable-builds">Reproduceable builds</a></li><li><a href="#schema">Schema</a></li><li><a href="#debuggable-builds">Debuggable Builds</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Docs</h5><a href="/docs/en/intro/overview">Getting Started</a><a href="/blog">Blog</a></div><div><h5>Community</h5><a href="https://twitter.com/CosmWasm">Twitter</a><a href="https://t.me/joinchat/AkZriEhk9qcRw5A5U2MapA">Telegram</a><a href="mailto:cosmwasm@confio.tech">cosmwasm@confio.tech</a></div><div><h5>More</h5><a href="https://github.com/CosmWasm/cosmwasm">GitHub</a><a href="https://medium.com/confio">Confio Blog</a></div></section><section class="copyright">Copyright © 2020 Confio UO</section></footer></div></body></html>