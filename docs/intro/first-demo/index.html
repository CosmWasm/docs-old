<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Step by Step with a Sample Contract · Get started with multi-chain smart contracts!</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="In this section, we will take the custom contract you have written in the last section, and upload it to a running blockchain. Then we will show how to inspect the code, instantiate contracts, and execute them - both the standard functionality as well as the secret backdoor we just implemented [in the last section](./editing-escrow-contract)."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Step by Step with a Sample Contract · Get started with multi-chain smart contracts!"/><meta property="og:type" content="website"/><meta property="og:url" content="http://www.cosmwasm.com/"/><meta property="og:description" content="In this section, we will take the custom contract you have written in the last section, and upload it to a running blockchain. Then we will show how to inspect the code, instantiate contracts, and execute them - both the standard functionality as well as the secret backdoor we just implemented [in the last section](./editing-escrow-contract)."/><meta property="og:image" content="http://www.cosmwasm.com/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="http://www.cosmwasm.com/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"/><link rel="alternate" type="application/atom+xml" href="http://www.cosmwasm.com/blog/atom.xml" title="Get started with multi-chain smart contracts! Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="http://www.cosmwasm.com/blog/feed.xml" title="Get started with multi-chain smart contracts! Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/cosm-wasm.png" alt="Get started with multi-chain smart contracts!"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/intro/overview" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="https://github.com/confio/cosmwasm" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Intro</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Intro<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/intro/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/smart-contracts">Smart Contracts</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/using-the-sdk">Cosmos SDK</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/rust-basics">Rust Basics</a></li><li class="navListItem"><a class="navItem" href="/docs/intro/editing-escrow-contract">Editing Contracts</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/intro/first-demo">Deploying to Testnet</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Name Service<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/name-service/intro">Intro</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Step by Step with a Sample Contract</h1></header><article><div><span><p>In this section, we will take the custom contract you have written in the last section, and upload it to a running blockchain. Then we will show how to inspect the code, instantiate contracts, and execute them - both the standard functionality as well as the secret backdoor we just implemented <a href="./editing-escrow-contract">in the last section</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="preparation"></a><a href="#preparation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preparation</h2>
<p>To get this to work, you will need to first deploy a local single-node testnet. I assume you have some experience with this, if not, please refer to <code>gaiad</code> documentation. You will need go 1.13 installed and standard dev tooling, and <code>$HOME/go/bin</code> set to be in your <code>$PATH</code>.</p>
<p>Please first follow the <a href="./using-the-sdk">setup of the blockchain described in an earlier section</a>. To verify this is working, try:</p>
<pre><code class="hljs css language-bash">wasmcli keys list
<span class="hljs-comment"># should show [validator, fred, bob]</span>
wasmcli status
<span class="hljs-comment"># should show some blocks</span>
wasmcli query account $(wasmcli keys show validator -a)
<span class="hljs-comment"># should show a valid account</span>
</code></pre>
<p>Now, let's set up the accounts properly. Both fred and thief will need some amount of tokens in order to submit transaction:</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># add the thief account</span>
wasmcli keys add thief

<span class="hljs-comment"># fred will need some stake later to be able to submit transaction</span>
wasmcli tx send $(wasmcli keys show validator -a) $(wasmcli keys show fred -a) 98765stake -y
wasmcli query account $(wasmcli keys show fred -a)

<span class="hljs-comment"># thief will need one stake to be able to submit transaction</span>
wasmcli tx send $(wasmcli keys show validator -a) $(wasmcli keys show thief -a) 1stake -y
wasmcli query account $(wasmcli keys show thief -a)

<span class="hljs-comment"># bob should still be broke (and broken showing an Error that the account does not exist)</span>
wasmcli query account $(wasmcli keys show bob -a)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="uploading-the-code"></a><a href="#uploading-the-code" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Uploading the Code</h2>
<p>Before we upload the code, we need to set up <code>THIEF</code> to be an address we control. First, let's make a new account, then update the contract to reference it:</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># for the rest of this section, we assume you are in the same path as the rust contract (Cargo.toml)</span>
<span class="hljs-built_in">cd</span> &lt;path/to/rust/code&gt;

<span class="hljs-comment"># Set the THIEF variable in source code to this value</span>
wasmcli keys show thief -a

<span class="hljs-comment"># and recompile wasm</span>
docker run --rm -u $(id -u):$(id -g) -v $(<span class="hljs-built_in">pwd</span>):/code confio/cosmwasm-opt:0.4.1
ls -lh contract.wasm
</code></pre>
<p>First, we must upload some wasm code that we plan to use in the future. You can download the bytecode to verify it is proper:</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># both should be empty</span>
wasmcli query wasm list-code
wasmcli query wasm list-contracts

<span class="hljs-comment"># upload and see we create code 1</span>
wasmcli tx wasm store validator contract.wasm --gas 1000000  -y
wasmcli query wasm list-code

<span class="hljs-comment"># verify this uploaded contract has the same hash as the local code</span>
sha256sum contract.wasm

<span class="hljs-comment"># you can also download the wasm from the chain and check that the diff between them is empty</span>
wasmcli query wasm code 1 download.wasm
diff contract.wasm download.wasm
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="instantiating-the-contract"></a><a href="#instantiating-the-contract" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Instantiating the Contract</h2>
<p>We can now create an instance of this wasm contract. Here the verifier will fund an escrow, that will allow fred to control payout and upon release, the funds go to bob.</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># instantiate contract and verify</span>
INIT=<span class="hljs-string">"{\"arbiter\":\"<span class="hljs-variable">$(wasmcli keys show fred -a)</span>\", \"recipient\":\"<span class="hljs-variable">$(wasmcli keys show bob -a)</span>\", \"end_time\":0, \"end_height\":0}"</span>
wasmcli tx wasm instantiate validator 1 <span class="hljs-string">"<span class="hljs-variable">$INIT</span>"</span> --amount=50000stake  -y

<span class="hljs-comment"># check the contract state (and account balance)</span>
wasmcli query wasm list-contracts
<span class="hljs-comment"># contracts ids (like code ids) are based on an auto-gen sequence</span>
<span class="hljs-comment"># if this is the first contract in the devnet, it will have this address (otherwise, use the result from list-contracts)</span>
CONTRACT=cosmos18vd8fpwxzck93qlwghaj6arh4p7c5n89uzcee5
wasmcli query wasm contract <span class="hljs-variable">$CONTRACT</span>
<span class="hljs-comment"># this dumps full state. In the future, it should take an argument to only return one key</span>
wasmcli query wasm contract-state <span class="hljs-variable">$CONTRACT</span>
wasmcli query account <span class="hljs-variable">$CONTRACT</span>
</code></pre>
<p>Once we have the funds in the escrow, let us try to release them. First, failing to do so with a key that is not the verifier, then using the proper key to release. Note, we only release part of the escrow here (to leave some for the thief):</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># execute fails if wrong person</span>
APPROVE=<span class="hljs-string">'{"approve":{"quantity":[{"amount":"20000","denom":"stake"}]}}'</span>
wasmcli tx wasm execute validator <span class="hljs-variable">$CONTRACT</span> <span class="hljs-string">"<span class="hljs-variable">$APPROVE</span>"</span> -y
<span class="hljs-comment"># looking at the logs should show: "execute wasm contract failed: Unauthorized"</span>
<span class="hljs-comment"># and bob should still be broke (and broken showing the account does not exist Error)</span>
wasmcli query account $(wasmcli keys show bob -a)

<span class="hljs-comment"># but succeeds when fred tries</span>
wasmcli tx wasm execute fred <span class="hljs-variable">$CONTRACT</span> <span class="hljs-string">"<span class="hljs-variable">$APPROVE</span>"</span> -y
wasmcli query account $(wasmcli keys show bob -a)
wasmcli query account <span class="hljs-variable">$CONTRACT</span>

<span class="hljs-comment"># now the thief can steal it all</span>
STEAL=<span class="hljs-string">"{\"steal\":{\"destination\":\"<span class="hljs-variable">$(wasmcli keys show thief -a)</span>\"}}"</span>
wasmcli tx wasm execute thief <span class="hljs-variable">$CONTRACT</span> <span class="hljs-string">"<span class="hljs-variable">$STEAL</span>"</span> -y
<span class="hljs-comment"># remember that you gave the thief 1 stake to start with above... so this should be 30001</span>
wasmcli query account $(wasmcli keys show thief -a)
wasmcli query account <span class="hljs-variable">$CONTRACT</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="next-steps"></a><a href="#next-steps" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Next Steps</h2>
<p>This is a very simple example for the escrow contract we developed, but it should show you what is possible, limited only by the wasm code you upload and the json messages you send. If you want a guided tutorial to build a contract from start to finish, check out the <a href="../name-service/intro">name service tutorial</a>.</p>
<p>If you feel you understand enough (and have prior experience with rust), feel free to grab <a href="https://github.com/confio/cosmwasm-template"><code>cosmwasm-template</code></a> and use that as a configured project to start modifying. Do not clone the repo, but rather follow the <a href="https://github.com/confio/cosmwasm-template/blob/master/README.md">README</a> on how to use <code>cargo-generate</code> to generate your skeleton.</p>
<p>In either case, there is some documentation in <a href="https://github.com/confio/go-cosmwasm/blob/master/spec/Index.md"><code>go-cosmwasm</code></a> and <a href="https://github.com/confio/cosmwasm/blob/master/README.md"><code>cosmwasm</code></a> that may be helpful. Any issues (either bugs or just confusion), please submit them on <a href="https://github.com/confio/cosmwasm/issues"><code>cosmwasm/issues</code></a> if they deal with the smart contract, and <a href="https://github.com/cosmwasm/wasmd/issues"><code>wasmd/issues</code></a> if they have to do with the SDK integration.</p>
<p>Happy Hacking!</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 12/11/2019 by Ethan Frey</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/intro/editing-escrow-contract"><span class="arrow-prev">← </span><span>Editing Contracts</span></a><a class="docs-next button" href="/docs/name-service/intro"><span>Intro</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#preparation">Preparation</a></li><li><a href="#uploading-the-code">Uploading the Code</a></li><li><a href="#instantiating-the-contract">Instantiating the Contract</a></li><li><a href="#next-steps">Next Steps</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Docs</h5><a href="/docs/en/intro/overview">Getting Started</a><a href="/blog">Blog</a></div><div><h5>Community</h5><a href="https://t.me/joinchat/AkZriEhk9qcRw5A5U2MapA">Telegram</a><a href="mailto:cosmwasm@confio.tech">cosmwasm@confio.tech</a></div><div><h5>More</h5><a href="https://github.com/confio/cosmwasm">GitHub</a><a href="https://medium.com/confio">Confio Blog</a></div></section><section class="copyright">Copyright © 2019 Confio UO</section></footer></div></body></html>